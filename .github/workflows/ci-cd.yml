name: GitOps Pipeline

# ðŸš€ GitOps: Git as Single Source of Truth
# Push to 'main' â†’ Production deployment
# Push to 'staging' â†’ Staging deployment
# Git branch determines environment automatically

on:
  push:
    branches: [ main, staging ]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - destroy

env:
  AZURE_WEBAPP_NAME_FRONTEND: carrental-frontend
  AZURE_WEBAPP_NAME_BFF: carrental-bff
  AZURE_FUNCTIONAPP_NAME: carrental-functions
  AZURE_RESOURCE_GROUP: rentacar-app-rg
  AZURE_CONTAINER_REGISTRY: carrentalacr
  NODE_VERSION: '24.x'

jobs:
  # Create Azure infrastructure (only on push to main)
  create-infrastructure:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && github.event.inputs.action != 'destroy'
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group
      run: |
        az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location westus2

    - name: Create Storage Account
      run: |
        az storage account create \
          --name carrentaloxre44puwcfng \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --location westus2 \
          --sku Standard_LRS \
          --kind StorageV2

    - name: Create Cosmos DB Account
      run: |
        az cosmosdb create \
          --name carrental-cosmos \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --locations regionName=westus2

    - name: Create Cosmos DB Database and Containers
      run: |
        az cosmosdb sql database create \
          --account-name carrental-cosmos \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name RentACarDB

        az cosmosdb sql container create \
          --account-name carrental-cosmos \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --database-name RentACarDB \
          --name Rentals \
          --partition-key-path "/bookingId"

        az cosmosdb sql container create \
          --account-name carrental-cosmos \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --database-name RentACarDB \
          --name Payments \
          --partition-key-path "/paymentId"

    - name: Create Storage Queues
      run: |
        STORAGE_KEY=$(az storage account keys list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --account-name carrentaloxre44puwcfng --query '[0].value' -o tsv)
        az storage queue create --name rent-queue --account-name carrentaloxre44puwcfng --account-key $STORAGE_KEY
        az storage queue create --name payment-queue --account-name carrentaloxre44puwcfng --account-key $STORAGE_KEY

    - name: Create Function App
      run: |
        az functionapp create \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --consumption-plan-location westus2 \
          --runtime node \
          --runtime-version 24 \
          --storage-account carrentaloxre44puwcfng \
          --functions-version 4

    - name: Create Container Registry
      run: |
        az acr create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_CONTAINER_REGISTRY }} \
          --sku Basic \
          --admin-enabled true

    - name: Create App Service Plan
      run: |
        az appservice plan create \
          --name carrental-webplan \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --sku S1 \
          --is-linux

    - name: Create BFF App Service
      run: |
        az webapp create \
          --name ${{ env.AZURE_WEBAPP_NAME_BFF }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --plan carrental-webplan \
          --runtime "NODE|24-lts"

    - name: Create Frontend App Service
      run: |
        az webapp create \
          --name ${{ env.AZURE_WEBAPP_NAME_FRONTEND }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --plan carrental-webplan \
          --runtime "NODE|24-lts"

  # Destroy Azure infrastructure (manual trigger only)
  destroy-infrastructure:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Destroy Resource Group
      run: |
        az group delete --name ${{ env.AZURE_RESOURCE_GROUP }} --yes --no-wait

  # Build and test applications
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install Azure Functions Core Tools
      run: |
        npm install -g azure-functions-core-tools@4 --unsafe-perm true

    - name: Test BFF Service
      run: |
        cd bff-service
        npm install
        npm test

    - name: Test Azure Functions
      run: |
        cd azure-functions
        npm install
        npm test

    - name: Build Frontend (check syntax)
      run: |
        cd frontend
        # Basic HTML/CSS/JS validation could be added here

  # Build and push Docker images
  build-and-push-docker:
    needs: [create-infrastructure, build-and-test]
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

    - name: Build and push BFF Service image
      run: |
        cd bff-service
        docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/bff-service:${{ github.sha }} .
        docker tag ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/bff-service:${{ github.sha }} ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/bff-service:latest
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/bff-service:${{ github.sha }}
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/bff-service:latest

    - name: Build and push Frontend image
      run: |
        cd frontend
        docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:${{ github.sha }} .
        docker tag ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:${{ github.sha }} ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:latest
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:${{ github.sha }}
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:latest

  # Deploy Azure Functions
  deploy-functions:
    needs: [create-infrastructure, build-and-test]
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install Azure Functions Core Tools
      run: |
        npm install -g azure-functions-core-tools@4 --unsafe-perm true

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure Functions App Settings
      run: |
        az functionapp config appsettings set \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings FUNCTIONS_WORKER_RUNTIME=node SCM_DO_BUILD_DURING_DEPLOYMENT=true

        # Wait for SCM to report updated settings (max 30 tries)
        for i in {1..30}; do
          if az functionapp config appsettings list --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[?name=='SCM_DO_BUILD_DURING_DEPLOYMENT']" -o tsv | grep -q SCM_DO_BUILD_DURING_DEPLOYMENT; then
            echo "SCM settings ready"
            break
          fi
          echo "Waiting for SCM settings... ($i/30)"
          sleep 5
        done

    - name: Deploy Azure Functions
      run: |
        cd azure-functions
        func azure functionapp publish ${{ env.AZURE_FUNCTIONAPP_NAME }} --javascript --build remote

  # Deploy to Azure App Services
  deploy-appservices:
    needs: [build-and-push-docker, deploy-functions]
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy BFF Service to App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME_BFF }}
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/bff-service:${{ github.sha }}

    - name: Deploy Frontend to App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME_FRONTEND }}
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/frontend:${{ github.sha }}

    - name: Configure BFF Service Environment Variables
      run: |
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME_BFF }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                     COSMOS_DB_CONNECTION_STRING="${{ secrets.COSMOS_DB_CONNECTION_STRING }}"

    - name: Ensure correct container ports
      run: |
        echo "Setting WEBSITES_PORT for BFF to 3000"
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME_BFF }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings WEBSITES_PORT=3000

        echo "Setting WEBSITES_PORT for Frontend to 80"
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME_FRONTEND }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings WEBSITES_PORT=80

        echo "Restarting apps to apply new settings"
        az webapp restart --name ${{ env.AZURE_WEBAPP_NAME_BFF }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
        az webapp restart --name ${{ env.AZURE_WEBAPP_NAME_FRONTEND }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true

    - name: Gather App Service Diagnostics
      run: |
        echo "--- FRONTEND APP SHOW ---"
        az webapp show --name ${{ env.AZURE_WEBAPP_NAME_FRONTEND }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} -o json
        echo "--- BFF APP SHOW ---"
        az webapp show --name ${{ env.AZURE_WEBAPP_NAME_BFF }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} -o json
        echo "--- FRONTEND CONTAINER CONFIG ---"
        az webapp config container show --name ${{ env.AZURE_WEBAPP_NAME_FRONTEND }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
        echo "--- BFF CONTAINER CONFIG ---"
        az webapp config container show --name ${{ env.AZURE_WEBAPP_NAME_BFF }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
        echo "--- FRONTEND DEPLOYMENT LOG ---"
        az webapp log deployment show --name ${{ env.AZURE_WEBAPP_NAME_FRONTEND }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
        echo "--- BFF DEPLOYMENT LOG ---"
        az webapp log deployment show --name ${{ env.AZURE_WEBAPP_NAME_BFF }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
        echo "--- ACR TAGS (frontend) ---"
        az acr repository show-tags --name ${{ env.AZURE_CONTAINER_REGISTRY }} --repository frontend -o table || true
        echo "--- ACR TAGS (bff-service) ---"
        az acr repository show-tags --name ${{ env.AZURE_CONTAINER_REGISTRY }} --repository bff-service -o table || true

  # Health check after deployment
  health-check:
    needs: deploy-appservices
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Run Health Check
      run: |
        npm install
        npm run health-check

